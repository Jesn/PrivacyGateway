name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: richpeople/privacy-gateway

jobs:
  # æž„å»ºGoäºŒè¿›åˆ¶æ–‡ä»¶
  build-binaries:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
          - goos: darwin
            goarch: amd64
            suffix: darwin-amd64
          - goos: darwin
            goarch: arm64
            suffix: darwin-arm64
          - goos: windows
            goarch: amd64
            suffix: windows-amd64.exe
          - goos: windows
            goarch: arm64
            suffix: windows-arm64.exe

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          go build -a -ldflags "-s -w -X main.version=$VERSION" -o privacy-gateway-${{ matrix.suffix }} .

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: privacy-gateway-${{ matrix.suffix }}
          path: privacy-gateway-${{ matrix.suffix }}

  # æž„å»ºDockeré•œåƒ
  build-docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # set latest tag for default branch
            type=ref,event=branch
            type=ref,event=pr
            # set version tag for tags
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            # set latest tag for main branch
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=Privacy Gateway
            org.opencontainers.image.description=Lightweight reverse proxy with privacy protection
            org.opencontainers.image.vendor=Privacy Gateway Team
            org.opencontainers.image.licenses=MIT

      - name: Build and push Docker image
        id: docker-build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDTIME=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}
            REVISION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.revision'] }}

      - name: Image digest
        if: github.event_name != 'pull_request'
        run: echo ${{ steps.docker-build.outputs.digest }}

  # åˆ›å»ºGitHub Release
  create-release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-binaries]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Debug information
        run: |
          echo "GitHub ref: ${{ github.ref }}"
          echo "GitHub event name: ${{ github.event_name }}"
          echo "Is tag: ${{ startsWith(github.ref, 'refs/tags/') }}"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: ./artifacts

      - name: Prepare release files
        run: |
          mkdir -p ./release
          find ./artifacts -name "privacy-gateway-*" -type f -exec cp {} ./release/ \;
          ls -la ./release/

      - name: Generate checksums
        run: |
          cd ./release
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Extract release notes
        id: extract-notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # å°è¯•ä»ŽCHANGELOG.mdæå–å‘å¸ƒè¯´æ˜Žï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          if [ -f CHANGELOG.md ]; then
            # æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
            awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md > release_notes.txt
          fi

          # å¦‚æžœæ²¡æœ‰æ‰¾åˆ°å‘å¸ƒè¯´æ˜Žï¼Œåˆ›å»ºé»˜è®¤çš„
          if [ ! -s release_notes.txt ]; then
            cat > release_notes.txt << EOF
          ## ðŸš€ Privacy Gateway $VERSION

          ### ðŸ“¦ ä¸‹è½½

          é€‰æ‹©é€‚åˆä½ ç³»ç»Ÿçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

          - **Linux AMD64**: \`privacy-gateway-linux-amd64\`
          - **Linux ARM64**: \`privacy-gateway-linux-arm64\`
          - **macOS Intel**: \`privacy-gateway-darwin-amd64\`
          - **macOS Apple Silicon**: \`privacy-gateway-darwin-arm64\`
          - **Windows AMD64**: \`privacy-gateway-windows-amd64.exe\`
          - **Windows ARM64**: \`privacy-gateway-windows-arm64.exe\`

          ### ðŸ³ Dockeré•œåƒ

          \`\`\`bash
          docker pull richpeople/privacy-gateway:$VERSION
          docker pull richpeople/privacy-gateway:latest
          \`\`\`

          ### âœ… æ ¡éªŒæ–‡ä»¶å®Œæ•´æ€§

          ä¸‹è½½ \`checksums.txt\` æ–‡ä»¶å¹¶éªŒè¯ï¼š

          \`\`\`bash
          sha256sum -c checksums.txt
          \`\`\`

          ### ðŸ“‹ æ›´æ–°å†…å®¹

          - ðŸ”’ éšç§ä¿æŠ¤ä»£ç†åŠŸèƒ½
          - ðŸŒ å¤šåè®®æ”¯æŒï¼ˆHTTP/HTTPS/WebSocketï¼‰
          - ðŸ“Š è®¿é—®æ—¥å¿—ç®¡ç†
          - ðŸ”§ çµæ´»çš„é…ç½®é€‰é¡¹
          EOF
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract-notes.outputs.version }}
          name: Privacy Gateway ${{ steps.extract-notes.outputs.version }}
          body_path: release_notes.txt
          files: |
            ./release/*
          draft: false
          prerelease: false
          generate_release_notes: true
